<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login | Prepa Concour</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/styles.css" />
    <style>
      .auth-card { max-width: 480px; margin: 2rem auto; padding: 1.25rem; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; }
      .auth-actions { display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; }
      .muted { color: #6b7280; font-size: .9rem; }
      .field { display: flex; flex-direction: column; gap: .35rem; margin-bottom: .75rem; }
      .field input { padding: .5rem .6rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; }
      .error { color: #b91c1c; margin: .5rem 0; }
      .success { color: #065f46; margin: .5rem 0; }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <h1>Login</h1>
        <nav aria-label="Primary">
          <ul class="nav">
            <li><a href="index.html">Home</a></li>
            <li><a href="login.html" aria-current="page">Login</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="container">
      <section class="auth-card">
        <h2 style="margin-top:0;">Sign in to your account</h2>
        <p class="muted">Accounts are created by the admin. If you don't have one, request via WhatsApp.</p>

        <div id="msg" class="muted" style="margin:.5rem 0 1rem 0;"></div>

        <form id="email-form">
          <div class="field">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" autocomplete="username" required />
          </div>
          <div class="field">
            <label for="password">Password</label>
            <input id="password" name="password" type="password" autocomplete="current-password" required />
          </div>
          <div class="auth-actions" style="margin-top:.75rem;">
            <button id="email-login" type="submit" class="btn">Sign in</button>
            <button id="google-login" type="button" class="btn" style="background:#1849d6;">Sign in with Google</button>
          </div>
        </form>

        <hr style="margin:1rem 0;border:none;border-top:1px solid #eee;" />

        <div class="auth-actions">
          <a id="signup-wa" class="btn" href="https://wa.me/23770290583?text=Hello%20I%20would%20like%20a%20Prepa%20Concour%20account" target="_blank" rel="noopener">Sign Up (WhatsApp)</a>
          <a id="reset" class="btn" href="#">Forgot password?</a>
          <a class="btn" href="attempts.html">Go to My Attempts</a>
        </div>

        <p class="muted" style="margin-top:.5rem;">Need help? WhatsApp: <a href="https://wa.me/23770290583" target="_blank" rel="noopener">+237 702 90 583</a></p>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>&copy; <span id="year"></span> Prepa Concour</p>
      </div>
    </footer>

    <script type="module" src="assets/js/firebase.js"></script>
    <script>
      document.getElementById('year').textContent = new Date().getFullYear();

      const setMsg = (text, type='') => {
        const el = document.getElementById('msg');
        el.textContent = text || '';
        el.className = type ? type : 'muted';
      };

      const bootLogin = () => {
        if (!window.fb) return;
        const { auth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged } = window.fb;

        onAuthStateChanged(auth, (user) => {
          if (user) {
            setMsg('Signed in. Redirecting to Home...', 'success');
            setTimeout(() => window.location.href = 'index.html', 500);
          }
        });

        const form = document.getElementById('email-form');
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          setMsg('Signing in...');
          try {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            await signInWithEmailAndPassword(auth, email, password);
          } catch (err) {
            console.warn(err);
            let friendly = 'Unable to sign in. Please check your email/password.';
            if (err && err.code) {
              if (err.code === 'auth/user-not-found') friendly = 'No user found with that email. Contact admin to create one.';
              else if (err.code === 'auth/wrong-password') friendly = 'Incorrect password.';
              else if (err.code === 'auth/too-many-requests') friendly = 'Too many attempts. Try again later.';
            }
            setMsg(friendly, 'error');
          }
        });

        const googleBtn = document.getElementById('google-login');
        googleBtn.addEventListener('click', async () => {
          try {
            await signInWithPopup(auth, new GoogleAuthProvider());
          } catch (err) {
            console.warn(err);
            setMsg('Google sign-in failed. Please try again or use email/password.', 'error');
          }
        });

        const reset = document.getElementById('reset');
        reset.addEventListener('click', async (e) => {
          e.preventDefault();
          const email = document.getElementById('email').value.trim();
          if (!email) { setMsg('Enter your email above, then click Forgot password.', 'error'); return; }
          try {
            await sendPasswordResetEmail(auth, email);
            setMsg('Password reset email sent. Check your inbox.', 'success');
          } catch (err) {
            console.warn(err);
            let friendly = 'Unable to send reset email.';
            if (err && err.code === 'auth/user-not-found') friendly = 'No user found with that email. Contact admin.';
            setMsg(friendly, 'error');
          }
        });
      };

      if (window.fb) bootLogin(); else window.addEventListener('firebase-ready', bootLogin, { once: true });
    </script>
  </body>
</html>
